/*-----------------------------------------------------------------------------
| Copyright (c) 2014, Nucleic Development Team.
|
| Distributed under the terms of the Modified BSD License.
|
| The full license is in the file COPYING.txt, distributed with this software.
-----------------------------------------------------------------------------*/
!function(a,b){"function"==typeof define&&define.amd?define([],function(){return a.kiwi=b()}):"object"==typeof exports?module.exports=b():a.kiwi=b()}(this,function(){var a;!function(a){!function(a){a[a.Le=0]="Le",a[a.Ge=1]="Ge",a[a.Eq=2]="Eq"}(a.Operator||(a.Operator={}));var b=(a.Operator,function(){function b(b,d,e){void 0===e&&(e=a.Strength.required),this._id=c++,this._operator=d,this._expression=b,this._strength=a.Strength.clip(e)}return b.Compare=function(a,b){return a.id()-b.id()},b.prototype.id=function(){return this._id},b.prototype.expression=function(){return this._expression},b.prototype.op=function(){return this._operator},b.prototype.strength=function(){return this._strength},b}());a.Constraint=b;var c=0}(a||(a={}));var a;!function(a){var b=function(){function a(a){void 0===a&&(a=""),this._value=0,this._context=null,this._id=c++,this._name=a}return a.prototype.id=function(){return this._id},a.prototype.name=function(){return this._name},a.prototype.setName=function(a){this._name=a},a.prototype.context=function(){return this._context},a.prototype.setContext=function(a){this._context=a},a.prototype.value=function(){return this._value},a.prototype.setValue=function(a){this._value=a},a.prototype.toJSON=function(){return{name:this._name,value:this._value}},a}();a.Variable=b;var c=0}(a||(a={}));var a;!function(a){function b(b){for(var c=0,d=new Map,e=0,f=b.length;f>e;++e){var g=b[e];if("number"==typeof g)c+=g;else if(g instanceof a.Variable)d.set(g,1);else{if(!(g instanceof Array))throw new Error("invalid Expression argument: "+g);if(2!==g.length)throw new Error("array must have length 2");var h=g[0],i=g[1];if("number"!=typeof h)throw new Error("array item 0 must be a number");if(!(i instanceof a.Variable))throw new Error("array item 1 must be a variable");d.set(i,h)}}return{terms:d,constant:c}}var c=function(){function a(){var a=b(arguments);this._terms=a.terms,this._constant=a.constant}return a.prototype.terms=function(){return this._terms},a.prototype.constant=function(){return this._constant},a.prototype.value=function(){var a=this._constant;return this._terms.forEach(function(b,c){a+=c.value()*b}),a},a}();a.Expression=c}(a||(a={}));var a;!function(a){var b;!function(a){function b(a,b,c,d){void 0===d&&(d=1);var e=0;return e+=1e6*Math.max(0,Math.min(1e3,a*d)),e+=1e3*Math.max(0,Math.min(1e3,b*d)),e+=Math.max(0,Math.min(1e3,c*d))}function c(b){return Math.max(0,Math.min(a.required,b))}a.create=b,a.required=b(1e3,1e3,1e3),a.strong=b(1,0,0),a.medium=b(0,1,0),a.weak=b(0,0,1),a.clip=c}(b=a.Strength||(a.Strength={}))}(a||(a={}));var a;return function(a){function b(a){var b=1e-8;return 0>a?b>-a:b>a}var c=function(){function c(){this._cnMap=new Map,this._rowMap=new Map,this._varMap=new Map,this._editMap=new Map,this._infeasibleRows=[],this._objective=new g,this._artificial=null,this._idTick=0}return c.prototype.addConstraint=function(a){if(this._cnMap.has(a))throw new Error("duplicate constraint");var c=this._createRow(a),d=c.row,e=c.tag,f=this._chooseSubject(d,e);if(0===f.type()&&d.allDummies()){if(!b(d.constant()))throw new Error("unsatifiable constraint");f=e.marker}if(0===f.type()){if(!this._addWithArtificialVariable(d))throw new Error("unsatisfiable constraint")}else d.solveFor(f),this._substitute(f,d),this._rowMap.set(f,d);this._cnMap.set(a,e),this._optimize(this._objective)},c.prototype.removeConstraint=function(a){var b=this._cnMap.get(a);if(!b)throw new Error("unknown constraint");this._cnMap["delete"](a),this._removeConstraintEffects(a,b);var c=b.marker;if(!this._rowMap["delete"](c)){var d=this._getMarkerLeavingSymbol(c);if(0===d.type())throw new Error("failed to find leaving row");var e=this._rowMap.get(d);this._rowMap["delete"](d),e.solveForEx(d,c),this._substitute(c,e)}this._optimize(this._objective)},c.prototype.hasConstraint=function(a){return this._cnMap.has(a)},c.prototype.addEditVariable=function(b,c){if(this._editMap.has(b))throw new Error("duplicate edit variable");if(c=a.Strength.clip(c),c===a.Strength.required)throw new Error("bad required strength");var d=new a.Expression(b),e=new a.Constraint(d,2,c);this.addConstraint(e);var f=this._cnMap.get(e),g={tag:f,constraint:e,constant:0};this._editMap.set(b,g)},c.prototype.removeEditVariable=function(a){var b=this._editMap.get(a);if(void 0===b)throw new Error("unknown edit variable");this._editMap["delete"](a),this.removeConstraint(b.constraint)},c.prototype.hasEditVariable=function(a){return this._editMap.has(a)},c.prototype.suggestValue=function(a,b){var c=this,d=this._editMap.get(a);if(void 0===d)throw new Error("unknown edit variable");var e=this._rowMap,f=b-d.constant;d.constant=b;var g=d.tag.marker,h=e.get(g);if(h)return h.add(-f)<0&&this._infeasibleRows.push(g),void this._dualOptimize();var i=d.tag.other,h=e.get(i);return h?(h.add(f)<0&&this._infeasibleRows.push(i),void this._dualOptimize()):(e.forEach(function(a,b){var d=a.coefficientFor(g);0!==d&&a.add(f*d)<0&&1!==b.type()&&c._infeasibleRows.push(b)}),void this._dualOptimize())},c.prototype.updateVariables=function(){var a=this;this._varMap.forEach(function(b,c){var d=a._rowMap.get(b);void 0!==d?c.setValue(d.constant()):c.setValue(0)})},c.prototype._getVarSymbol=function(a){var b=this._varMap.get(a);return b||(b=this._makeSymbol(1),this._varMap.set(a,b)),b},c.prototype._createRow=function(c){var d=this,e=c.expression(),h=new g(e.constant());e.terms().forEach(function(a,c){if(!b(a)){var e=d._getVarSymbol(c),f=d._rowMap.get(e);void 0!==f?h.insertRow(f,a):h.insertSymbol(e,a)}});var i=this._objective,j=c.strength(),k={marker:f,other:f};switch(c.op()){case 0:case 1:var l=0===c.op()?1:-1,m=this._makeSymbol(2);if(k.marker=m,h.insertSymbol(m,l),j<a.Strength.required){var n=this._makeSymbol(3);k.other=n,h.insertSymbol(n,-l),i.insertSymbol(n,j)}break;case 2:if(j<a.Strength.required){var o=this._makeSymbol(3),p=this._makeSymbol(3);k.marker=o,k.other=p,h.insertSymbol(o,-1),h.insertSymbol(p,1),i.insertSymbol(o,j),i.insertSymbol(p,j)}else{var q=this._makeSymbol(4);k.marker=q,h.insertSymbol(q)}}return h.constant()<0&&h.reverseSign(),{row:h,tag:k}},c.prototype._chooseSubject=function(a,b){var c=f;if(a.cells().forEach(function(a,b){c===f&&1===b.type()&&(c=b)}),c!==f)return c;var d=b.marker.type();return(2===d||3===d)&&a.coefficientFor(b.marker)<0?b.marker:(d=b.other.type(),(2===d||3===d)&&a.coefficientFor(b.other)<0?b.other:f)},c.prototype._addWithArtificialVariable=function(a){var c=this._makeSymbol(2);this._rowMap.set(c,a.copy()),this._artificial=a.copy(),this._optimize(this._artificial);var d=b(this._artificial.constant());this._artificial=null;var e=this._rowMap.get(c);if(void 0!==e){if(this._rowMap["delete"](c),e.isConstant())return d;var f=this._anyPivotableSymbol(e);if(0===f.type())return!1;e.solveForEx(c,f),this._substitute(f,e),this._rowMap.set(f,e)}return this._rowMap.forEach(function(a){a.removeSymbol(c)}),this._objective.removeSymbol(c),d},c.prototype._substitute=function(a,b){var c=this;this._rowMap.forEach(function(d,e){d.substitute(a,b),d.constant()<0&&1!==e.type()&&c._infeasibleRows.push(e)}),this._objective.substitute(a,b),this._artificial&&this._artificial.substitute(a,b)},c.prototype._optimize=function(a){for(;;){var b=this._getEnteringSymbol(a);if(0===b.type())return;var c=this._getLeavingSymbol(b);if(0===c.type())throw new Error("the objective is unbounded");var d=this._rowMap.get(c);this._rowMap["delete"](c),d.solveForEx(c,b),this._substitute(b,d),this._rowMap.set(b,d)}},c.prototype._dualOptimize=function(){for(var a=this._rowMap,b=this._infeasibleRows;0!==b.length;){var c=b.pop(),d=a.get(c);if(d&&d.constant()<0){var e=this._getDualEnteringSymbol(d);if(0===e.type())throw new Error("dual optimize failed");a["delete"](c),d.solveForEx(c,e),this._substitute(e,d),a.set(e,d)}}},c.prototype._getEnteringSymbol=function(a){var b=f;return a.cells().forEach(function(a,c){b===f&&0>a&&4!==c.type()&&(b=c)}),b},c.prototype._getDualEnteringSymbol=function(a){var b=this,c=Number.MAX_VALUE,d=f;return a.cells().forEach(function(a,e){if(a>0&&4!==e.type()){var f=b._objective.coefficientFor(e),g=f/a;c>g&&(c=g,d=e)}}),d},c.prototype._getLeavingSymbol=function(a){var b=Number.MAX_VALUE,c=f;return this._rowMap.forEach(function(d,e){if(1!==e.type()){var f=d.coefficientFor(a);if(0>f){var g=-d.constant()/f;b>g&&(b=g,c=e)}}}),c},c.prototype._getMarkerLeavingSymbol=function(a){var b=Number.MAX_VALUE,c=b,d=b,e=f,g=e,h=e,i=e;return this._rowMap.forEach(function(b,e){var f=b.coefficientFor(a);if(0!==f)if(1===e.type())i=e;else if(0>f){var j=-b.constant()/f;c>j&&(c=j,g=e)}else{var j=b.constant()/f;d>j&&(d=j,h=e)}}),g!==e?g:h!==e?h:i},c.prototype._removeConstraintEffects=function(a,b){3===b.marker.type()&&this._removeMarkerEffects(b.marker,a.strength()),3===b.other.type()&&this._removeMarkerEffects(b.other,a.strength())},c.prototype._removeMarkerEffects=function(a,b){var c=this._rowMap.get(a);c?this._objective.insertRow(c,-b):this._objective.insertSymbol(a,-b)},c.prototype._anyPivotableSymbol=function(a){var b=f;return a.cells().forEach(function(a,c){var d=c.type();b!==f||2!==d&&3!==d||(b=c)}),b},c.prototype._makeSymbol=function(a){return new e(a,this._idTick++)},c}();a.Solver=c;var d;!function(a){a[a.Invalid=0]="Invalid",a[a.External=1]="External",a[a.Slack=2]="Slack",a[a.Error=3]="Error",a[a.Dummy=4]="Dummy"}(d||(d={}));var e=function(){function a(a,b){this._id=b,this._type=a}return a.prototype.id=function(){return this._id},a.prototype.type=function(){return this._type},a}(),f=new e(0,-1),g=function(){function a(a){void 0===a&&(a=0),this._cellMap=new Map,this._constant=a}return a.prototype.cells=function(){return this._cellMap},a.prototype.constant=function(){return this._constant},a.prototype.isConstant=function(){return 0===this._cellMap.size},a.prototype.allDummies=function(){var a=!0;return this._cellMap.forEach(function(b,c){4!==c.type()&&(a=!1)}),a},a.prototype.copy=function(){var b=new a(this._constant);return this._cellMap.forEach(function(a,c){b._cellMap.set(c,a)}),b},a.prototype.add=function(a){return this._constant+=a},a.prototype.insertSymbol=function(a,c){void 0===c&&(c=1),c+=this._cellMap.get(a)||0,this._cellMap.set(a,c),b(c)&&this._cellMap["delete"](a)},a.prototype.insertRow=function(a,b){var c=this;void 0===b&&(b=1),this._constant+=a._constant*b,a._cellMap.forEach(function(a,d){c.insertSymbol(d,a*b)})},a.prototype.removeSymbol=function(a){this._cellMap["delete"](a)},a.prototype.reverseSign=function(){var a=this;this._constant=-this._constant,this._cellMap.forEach(function(b,c){a._cellMap.set(c,-b)})},a.prototype.solveFor=function(a){var b=this._cellMap,c=-1/b.get(a);b["delete"](a),this._constant*=c,b.forEach(function(a,d){b.set(d,a*c)})},a.prototype.solveForEx=function(a,b){this.insertSymbol(a,-1),this.solveFor(b)},a.prototype.coefficientFor=function(a){return this._cellMap.get(a)||0},a.prototype.substitute=function(a,b){var c=this._cellMap.get(a);void 0!==c&&(this._cellMap["delete"](a),this.insertRow(b,c))},a}()}(a||(a={})),a});